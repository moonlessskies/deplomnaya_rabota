<!DOCTYPE html>
<html lang="ru">
<head>
  <title>Электронное учебное пособие Соадминистрирование баз данных и серверов</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/style.css">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>


  <header class="header">
    <div class="container">
      <div class="header__inner">
        <div class="header__logo">
         <img src="images/logotype-active.png" width="100px" alt="">
         <div class="name">
           <h2>Электронное учебное пособие</h2>
           <h2>Соадминистрирование баз данных и серверов</h2>
         </div>
         <a id="top"></a>
        </div>
        <nav class="nav">
          <a class="nav__link" href="index.html">Учебник</a>
          <a class="nav__link" href="basepr.html">Практика</a>
          <a class="nav__link" href="video1.html">Видео материал</a>
        </nav>
      </div>
    </div>
  </header>
<div class="layout">
  <aside class="aside-menu">
    <div class="block" id="block-htmlbook-block-28"><div class="block-content"></div></div>
    <div class="block" id="block-htmlbook-book-navigation">
       <h2 class="block-title">Содержание</h2>
     <div class="block-content">
  <ul class="menu">
                 <li class="leaf-collapsed">

                 <a class="not-active" href="index.html">Раздел 1. Технологии администрирования серверов и баз данных</a>
                    </li>
                    <li class="leaf-collapsed">

                 <a class="not-active">Тема 1.1. Принципы построения и администрирования баз данных
                        </a>
                       </li>
                         <div class="sub-menu">
                           <li class="leaf-collapsed">
                        <a class="not-active" href="book111.html">1.Обязанности администратора баз данных. Основные утилиты администратора баз данных. Режимы запуска и останова базы данных.</a>
                              </li>

     	      <li class="leaf-collapsed">

         <a class="not-active" href="book112.html">2.Пользователи базы данных. Привилегии, назначение привилегий. Управление пользователями баз данных</a>
               </li>
               <li class="leaf-collapsed">

         <a class="not-active" href="book113.html">3.Табличные пространства и файлы данных. Модели и типы данных.</a>
               </li>
     	      <li class="leaf-collapsed">

         <a class="not-active" href="book114.html">4.Схемы и объекты схемы данных. Блоки данных, экстенты сегменты.</a>
               </li>
     	      <li class="leaf-collapsed">

         <a class="not-active" href="book115.html">5.Структуры памяти. Однопроцессорные и многопроцессорные базы данных</a>
               </li>
     	      <li class="leaf-collapsed">

         <a class="not-active" href="book116.html">6.Транзакции, блокировки и согласованность данных</a>
               </li>
     	      <li class="leaf-collapsed">

         <a class="not-active" href="book117.html">7.Журнал базы данных: структура и назначение файлов журнала, управление переключениями и контрольными точками</a>
               </li>
     	      <li class="leaf-collapsed">

         <a class="not-active" href="book118.html">8. Словарь данных: назначение, структура, префиксы </a>
               </li>
     	      <li class="leaf-collapsed">

         <a class="not-active" href="book119.html">9. Правила Дейта</a>
               </li>
             </div>

     	      <li class="leaf-collapsed">

         <a class="not-active">Тема 1.2. Серверы баз данных</a>
               </li>

               <div class="sub-menu">

     	      <li class="leaf-collapsed">


         <a class="not-active" href="book121.html">1.Понятие сервера. Классификация серверов. Принципы разделения между клиентскими и серверными частями. Типовое разделение функций</a>
               </li>
     	      <li class="leaf-collapsed">

         <a class="not-active" href="book122.html">2.Протоколы удаленного вызова процедур. Требования к аппаратным возможностям и базовому программному обеспечению клиентов и серверов</a>
               </li>
     	      <li class="leaf-collapsed">
         <a class="not-active" href="book123.html">3.Хранимые процедуры и триггеры</a>
               </li>
     	      <li class="leaf-collapsed">

         <a class="not-active" href="book124.html">4.Характеристики серверов баз данных. Механизмы доступа к базам данных</a>
               </li>
               <li class="leaf-collapsed">
              <a class="not-active" href="book125.html">5. Аппаратное обеспечение. Для квалификации «Администратор баз данных»: Развертывание серверов баз данных</a>
                  </li>
                  <li class="leaf-collapsed">
                 <a class="not-active" href="book126.html">6. Банк данных: состав, схема</a>
                     </li>
             </div>
             <li class="leaf-collapsed">
          <a class="not-active">Тема 1.3.Администрирование баз данных и серверов</a>
                </li>
     <div class="sub-menu">
      <li class="leaf-collapsed">
      <a class="not-active" href="book131.html">1.Технология установки и настройка сервера MySQL в операционной системе Windows.Клиентские настhойки, протоколирование, безопасность</a>
         </li>
         <li class="leaf-collapsed">
      <a class="not-active" href="book132.html">2.Технология установки и настройка сервера MySQL в операционных системах Linux</a>
            </li>
            <li class="leaf-collapsed">
         <a class="not-active" href="book133.html">3.Удаленное администрирование</a>
               </li>
               <li class="leaf_active-trail">
        <a href="book134.html" class="is-active">4.Аудит базы данных. Аудиторский журнал. Установка опций, включение и отключение аудита. Очистка и уменьшение размеров журнала
               <span class="pointer" style="border-width: 11px 6px;"></span></a>
              </li>

                  <li class="leaf-collapsed">
               <a class="not-active" href="book135.html">5.Технологии создания базы данных с применением языка SQL.Добавление, удаление данных и таблиц</a>
                     </li>
                     <li class="leaf-collapsed">
                  <a class="not-active" href="book136.html">6.Создание запросов, процедур и триггеров. Для квалификации «Администратор баз данных». Создание запросов и процедур на изменение структуры базы данных</a>
                        </li>
                        <li class="leaf-collapsed">
                     <a class="not-active" href="book137.html">7.Динамический SQL и его операторы.</a>
                           </li>
                           <li class="leaf-collapsed">
                        <a class="not-active" href="book138.html">8.Особенности обработки данных в объектно-ориентированных базах данных</a>
                              </li>
                              <li class="leaf-collapsed">
                           <a class="not-active" href="book139.html">9. Инструменты мониторинга нагрузки сервера</a>
                                 </li>

    </div>
    <li class="leaf-collapsed">
    <a class="not-active" href="index.html">Раздел 2. Обеспечение качества и сертификация информационных систем </a>
       </li>
       <li class="leaf-collapsed">
     <a class="not-active">Тема 2.1. Защитаи сохранность информации баз данных</a>
          </li>
     <div class="sub-menu">
          <li class="leaf-collapsed">
        <a class="not-active" href="book211.html">1.Законодательство Российской Федерации в области защиты информации. Требования безопасности к серверам баз данных. Классы защиты</a>
             </li>
             <li class="leaf-collapsed">
           <a class="not-active" href="book212.html">2.Основные группы методов противодействия угрозам безопасности в корпоративных сетях</a>
                </li>
                <li class="leaf-collapsed">
             <a class="not-active" href="book213.html">3.Программно-аппаратные методы защиты процесса обработки и передачи информации. Политика безопасности, настройка политики безопасности</a>
                   </li>
                   <li class="leaf-collapsed">
                <a class="not-active" href="book214.html">4.Виды неисправностей систем хранения данных</a>
                      </li>
                      <li class="leaf-collapsed">
                   <a class="not-active" href="book215.html">5.Резервное копирование: цели, методы, концепции, планирование, роль журнала транзакций. Виды резервных копий</a>
                         </li>
                         <li class="leaf-collapsed">
                      <a class="not-active" href="book216.html">6.Утилиты резервного копирования </a>
                            </li>
                            <li class="leaf-collapsed">
                         <a class="not-active" href="book217.html">7.Восстановление базы данных: основные алгоритмы и этапы</a>
                               </li>
                               <li class="leaf-collapsed">
                            <a class="not-active" href="book218.html">8.Восстановление носителей. Воссоздание утраченных файлов. Полное восстановление. Неполное восстановление</a>
                                  </li>
                                  <li class="leaf-collapsed">
                               <a class="not-active" href="book219.html">9.Мониторинг активности и блокирование</a>
                                     </li>
                                     <li class="leaf-collapsed">
                                  <a class="not-active" href="book2110.html">10.Автоматизированные средства аудита</a>
                                        </li>
                                        <li class="leaf-collapsed">
                                     <a class="not-active" href="book2111.html">11.Брандмауэры</a>
                                           </li>
                                  </div>
     <li class="leaf-collapsed">
      <a class="not-active">Тема 2.2 Сертификация информационных систем</a>
        </li>
        <div class="sub-menu">
        <li class="leaf-collapsed">
         <a class="not-active" href="book221.html">1.Уровни качества программной продукции</a>
           </li>
           <li class="leaf-collapsed">
            <a class="not-active" href="book222.html">2.Требования к конфигурации серверного оборудования и локальных сетей.Оформление требований.</a>
              </li>
              <li class="leaf-collapsed">
               <a class="not-active" href="book223.html">3.Объекты информатизации, требующие обязательной сертификации программных средств и обеспечения</a>
                 </li>
                 <li class="leaf-collapsed">
                  <a class="not-active" href="book224.html">4.Сертификаты безопасности: виды, функции, срок действия. Проверка наличия сертификата безопасности</a>
                    </li>
                    <li class="leaf-collapsed">
                     <a class="not-active" href="book225.html">5. Системы сертификации. Процедура сертификации.</a>
                       </li>
                       <li class="leaf-collapsed">
                        <a class="not-active" href="book226.html">6. Платформы и центры сертификации. Сертификат разработчика. Процесс подписи и проверки кода</a>
                          </li>
                          <li class="leaf-collapsed">
                           <a class="not-active" href="book227.html">7. SSL сертификат: содержание, формирование запроса, проверка данных с помощью сервисов</a>
                             </li>
                             <li class="leaf-collapsed">
                              <a class="not-active" href="spicok.html">Список источников</a>
                                </li>
                              </div>
                                                       </ul>



     </div>
    </div>
 </aside>

 <div id="content" class="three-col">
   <div class="block" id="block-content">
     <div class="block-content">
       <article role="article">
         <h1 class="h1-content"><span>4.Аудит базы данных. Аудиторский журнал. Установка опций, включение и отключение аудита. Очистка и уменьшение размеров журнала</span></h1>
         <nav role="navigation" aria-labelledby="book-label-2" class="book-navigation">
           <div class="page-links"><a href="book133.html" rel="prev" class="page-previous" title="Прошлая Тема">
             <i class="arrow icon-prev"><img src="images/arrowleft.png" alt=""></i>Тема 3.3</a>
             <a href="index.html" class="page-up" title="Содержание"><i class="arrow icon-up">
             <img src="images/arrowup.png" alt=""></i>Содержание</a>
             <a href="book135.html" rel="next" class="page-next" title="Следующая тема">Тема 3.5.
               <i class="arrow icon-next"><img src="images/arrowright.png" alt=""></i>
             </a>
           </div>
         </nav>
           <div>
<h1>АУДИТ MS SQL СЕРВЕРА</h1>
<p>Аудит – это наблюдение за выбранными действиями пользователей базы данных. Его обычное применение это контроль подозрительных операций и сбор информации об отдельных действиях в базе данных. В этой главе мы научимся включать, настраивать, просматривать и анализировать аудит, а также рассмотрим его расширения.
</p>
<h2>Включаем аудит
</h2>
<p>Для включения аудита нам достаточно изменить значение инициализационного параметра AUDIT_TRAIL. Для начала подключимся к экземпляру базы данных и выведем его значение:
</p>
<p class="img-content"><img src="images/book1341.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Как видим параметр, имеет значение NONE, то есть аудит находиться по умолчанию в выключенном состоянии. Включим его, присвоив параметру значение DB:
</p>
<p class="img-content"><img src="images/book1342.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Для того чтобы изменения вступили в силу, нам необходимо перезагрузить экземпляр базы данных. Но прежде чем это сделать, изменим ещё один дополнительный инициализационный параметр AUDIT_SYS_OPERATIONS, отвечающий за включение аудита для пользователя SYS и пользователей имеющих привилегии SYSDBA и SYSOPER. Выведем его значение:
</p>
<p class="img-content"><img src="images/book1343.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Видно, что по умолчанию аудит действий для этой группы пользователей выключен. Включим его:
</p>
<p class="img-content"><img src="images/book1344.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Теперь, после того как все параметры были установлены в нужные значения, можно перезагрузить экземпляр:
</p>
<p class="img-content"><img src="images/book1345.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Проверим, правильность установки значения инициализационных параметров:
</p>

<p class="img-content"><img src="images/book1346.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Значения правильные. Аудит включён, и можно переходить к его настройке.
</p>
<h2>Приступаем к настройке
</h2>
<p>Настройка аудита представляет собой включение или выключение опций протоколирования выполняемых операций. Установка опций требует наличие привилегий AUDIT SYSTEM и AUDIT ANY, и может происходить на трёх уровнях аудита: команд, привилегий и объектов схемы. Рассмотрим настройку каждого уровня по отдельности. Первое, что мы сделаем, это применим аудит для команды ALTER SYSTEM, которая может динамически изменить текущий экземпляр базы данных. Включение опции производится следующим оператором:
</p>

<p class="img-content"><img src="images/book1347.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>В результате, мы имеем первую установленную опцию и можем уже отслеживать действия по изменению текущего экземпляра базы данных. Правда следует сразу отметить, что включение опции не означает немедленное протоколирование команды для пользователей, которые в текущий момент времени уже подключены к базе данных. Аудит для них будет действовать, только начиная со следующего сеанса.
</p>
<p>После того как мы произвели включение данной опции, мы должны проверить правильность её установки. Для этого нам надо сделать запрос к следующему представлению:
</p>
<p class="img-content"><img src="images/book1348.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Из результатов запроса видно, что сейчас у нас в системе одна установленная опция ALTER SYSTEM, настроенная на протоколирование действий одноимённой команды. На самом деле большинство опций аудита команд включают в себя группы связанных операторов. Включим, к примеру, следующую опцию:
</p>


<p class="img-content"><img src="images/book1349.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>В результате мы добавили аудит сразу на три команды: CREATE USER, ALTER USER и DROP USER, и с помощью одной включенной опции USER можем полностью отслеживать все действия, совершаемые с учетными записями пользователей. Всего опций аудита команд не один десяток. Можно конечно могли включить их все с помощью сокращения ALL, но политика аудита подразумевает ограничивать количество отслеживаемых событий, насколько это возможно. Поэтому мы включим только те опции, которые необходимы для минимального функционирования аудита. В дополнение к уже двум ранее установленным опциям, нам необходимо настроить протоколирование команд связанных с изменением ролей и профилей пользователей: CREATE PROFILE, ALTER PROFILE, DROP PROFILE, CREATE ROLE, ALTER ROLE, DROP ROLE, SET ROLE. Делается это с помощью включения двух опции PROFILE и ROLE. Также имеет смысл установить опцию SYSTEM GRANT, для того чтобы мы могли отслеживать выдачу, отбор системных привилегий и ролей с помощью команд GRANT, REVOKE. Защите настройки аудита тоже надо уделить особое внимание. Поэтому мы включим опцию SYSTEM AUDIT. Это позволит протоколировать действия совершаемые командами AUDIT и NOAUDIT. В заключение произведём установку опции SESSION, которая в определённом смысле является уникальной, так как не ассоциируется ни с одной командой. Смысл этой опции в формировании записи аудита при подключении сеанса и обновлении записи при его отключении. Включение всех вышеперечисленные опций можно оформить в виде одного оператора, что мы сейчас и сделаем:
</p>
<p class="img-content"><img src="images/book13410.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>После того как нами была произведена установка аудита операторов относящихся в основном к системе, мы можем перейти к включению опций команд, связанных непосредственно с объектами, как типом. В первую очередь мы должны настроить протоколирование DDL команд, осуществляющих действия над таким важным объектом как таблица. Надо отследить не только создание, изменение и удаление таблицы, но и полную очистку хранящихся в ней данных. Поэтому следующей опцией, которую мы включим, будет опция TABLE. Она активирует аудит сразу трёх команд CREATE TABLE, DROP TABLE и TRUNCATE TABLE. В перечисленном списке нет команды ALTER TABLE, поэтому нам придётся настроить дополнительную опцию с одноимённым названием.</p><p>
В качестве следующего типа объекта, который подвергнется аудиту, мы выберем триггер, так как он является важной частью в поддержании целостности данных. Здесь нам надо учитывать, что триггеры могут находиться в двух состояниях. Поэтому надо протоколировать не только команды создания и удаления триггера, но также и операторы его включения и выключения. И сделать это нам поможет включение опции TRIGGER, которая активирует аудит команд CREATE TRIGGER, ALTER TRIGGER EHABLE (DISABLE), DROP TRIGGER, ALTER TABLE ENABLE (DISABLE) ALL TRIGGERS.</p><p>
Следующая опция аудита, которую мы рассмотрим, объединяет целый список типов объектов. Она имеет название PROCEDURE и включает аудит на команды CREATE и DROP применяемые к хранимым объектам. Активация данной опции зависит от нескольких условий и специфична для конкретной системы. Если, к примеру, происходит частая модификация хранимых объектов, которую осуществляет только администратор по просьбе разработчиков приложения, то данную опцию можно выключить, чтобы ограничить число записей в аудите. Если же лиц, которые могут модифицировать данный тип объектов несколько, то данную опцию лучше активировать. Мы же этого делать не будем, и поэтому произведем включение только первых трёх опций:
</p>
<p class="img-content"><img src="images/book13411.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Последние опции, которые мы включим, относятся к протоколированию команд GRANT REVOKE, предоставляющих или отбирающих объектные привилегии. В качестве объектов здесь выступают хранимые объекты и таблицы. Для обнаружения несанкционированной выдачи на них привилегий, мы и включим две опции GRANT PROCEDURE и GRANT TABLE:
</p>
<p class="img-content"><img src="images/book13412.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Теперь проверим результат нашей работы:
</p>
<p class="img-content"><img src="images/book13413.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Минимальный набор опций включен, и мы можем уже иметь хоть какое-то представление о действиях пользователей в базе данных. Но если количество этих действий достаточно велико это может привести к неоправданному росту журнала аудита и впоследствии к трудностям его анализа. Для того чтобы избежать этой ситуации, в аудите можно использовать фокусировку. Предназначение фокусировки вытекает из самого названия. Она необходима для сужения области действия аудита, с целью уменьшить количество генерируемых контрольных записей. По умолчанию, фокусировка для опций не осуществляется. Поэтому мы рассмотрим, её применение на конкретном примере установленной нами опции ROLE. Эта опция включает протоколирование четырёх команд: CREATE ROLE, ALTER ROLE, DROP ROLE, SET ROLE. Если приложения базы данных построены по принципу включения ролей, то при большом количестве работающих пользователей будет генерироваться значительное количество записей аудита из-за выполнения команды SET ROLE. Попробуем избежать это ситуации, установив эту опцию только для неудачного выполнения команд. Для начала посмотрим режим фокусировки для всех настроенных нами опций аудита команд, выполнив следующий запрос:
</p>
<p class="img-content"><img src="images/book13414.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Значение BY ACCESS в столбце SUCCESS(FAILURE) говорит о том, что записи аудита для данной опции будут образовываться при каждом удачном (неудачном) выполнении команды. Этот режим для DDL команд устанавливается по умолчанию и фокусировка здесь отсутствует. Отменим регистрацию удачного выполнения команды для опции ROLE:
</p>
<p class="img-content"><img src="images/book13415.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>В столбце SUCCESS напротив опции ROLE появилось значение NOT SET. Теперь при удачном выполнении команд связанных с действиями над ролями аудит генерироваться не будет. Количество записей, конечно, уменьшится, но мы не сможем больше отслеживать создание, изменение и удаление ролей. Впрочем, как обойти этот недостаток, мы рассмотрим в настройке следующего типа аудита - аудита привилегий.
</p>
<p>В настройке аудита привилегий в качестве опций используются непосредственно системные привилегии, и генерация аудита осуществляется в том случае, если эти привилегии применяются при выполнении SQL оператора. Настройка этого типа аудита осуществляется тогда, когда требуется настроить протоколирование не связанного списка команд, а конкретных операторов. Рассмотрим это на примере всё той же опции ROLE. С целью уменьшения количества генерируемых записей для неё была применена фокусировка, и теперь удачные выполнения DDL команд над ролями не попадают в аудит. Чтобы исправить эту ситуацию мы будем отслеживать удачное применение привилегий CREATE ROLE, ALTER ANY ROLE, DROP ANY ROLE. Для этого выполним следующий оператор:
</p>
<p class="img-content"><img src="images/book13416.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Теперь выберем список опций привилегий, к которым применён аудит:
</p>

<p class="img-content"><img src="images/book13417.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>В результате, все удачно выполненные команды, которые требуют привилегий, CREATE ROLE, ALTER ANY ROLE и DROP ANY ROLE теперь будут попадать в аудит. Так, используя совместную фокусировку аудита команд и привилегий, нам удалось сократить количество генерируемых записей за счет исключения протоколирования успешного выполнения команды SET ROLE. Но фокусировка этих двух типов аудита не ограничивается только результатом выполнения команд, её также можно применять и для конкретных пользователей. Рассмотрим это на основе демонстрационной схемы HR. Для этого создадим предварительно нужные нам роли и учётные записи пользователей. Сделав запрос к справочнику EMPLOYEES, мы увидим, что в фирме имеются пять служащих IT отдела:
</p>
<p class="img-content"><img src="images/book13418.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Допустим, что двое из них Alexander Hunold и Bruce Ernst осуществляют сопровождение объектов схемы HR. Так как у этих пользователей довольно широкие привилегии в этой схеме, нам потребуется отслеживать все DML команды, которые они могут выполнить. Поэтому включим для них следующие опции:
</p>


<p class="img-content"><img src="images/book13419.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Проверим список опций команд для пользователей:
</p>



  <p class="img-content"><img src="images/book13420.png" alt="Рис. 1.1" width="608" height="296"></p>

<p>Теперь мы будем знать, осуществлялся ли доступ к таблицам и представлениям схемы HR со стороны пользователей AH и BE. Это позволит сократить количество записей по сравнению со случаем, когда нам пришлось бы включать протоколирование этих действий для всех пользователей, а затем выискивать в журнале аудита записи нужного нам пользователя. Здесь я хочу обратить внимание на содержание столбцов SUCCESS и FAILURE в списке опций, как ещё одного из видов фокусировки. До этого мы встречали в них только значение BY ACCESS, что означало, что запись аудита будет создаваться при каждом выполнении SQL оператора включенной опции. Данный режим является единственным для опций, содержащих набор DDL команд. Но для аудита DML операторов существует и ещё один режим - BY SESSION. При данном виде фокусировки запись аудита будет образовываться только один раз за весь сеанс и только при первом выполнении команды. Данный режим используется для фиксации самого факта доступа к данным и для опций DML команд устанавливается по умолчанию.
</p>
<p>Рассматривая последний пример, мы увидели, как можно настроить аудит доступа пользователя к данным таблиц и представлений. Но используемый нами вариант не лишен недостатков. В аудит попутно попадут все обращения пользователя к доступным ему представлениям и таблицам. Такой аудит удобно включать только кратковременно, для поиска подозрительной активности в базе данных. Если же нам потребуется постоянно отслеживать доступ к одному или нескольким объектам, то такой метод становиться очень затратным. Для того чтобы исключить такую ситуацию можно применить ещё один тип аудита – аудит объектов схемы. Его отличие от аудита команд и привилегий состоит в том, что протоколирование применяется только к конкретному объекту, а опции ассоциируются с одиночными командами. Рассмотрим это на основе последнего примера. Для того чтобы сократить количество записей аудита генерируемых текущей настройкой, попробуем отследить доступ к данным только критически важных таблиц HR.EMPLOYEES и HR.JOBS. Вначале отключим лишние опции аудита DML команд для пользователей AH и BE:
</p>
<p class="img-content"><img src="images/book13421.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Теперь активируем опции аудита объектов схемы для таблиц hr.employees и hr.jobs:
</p>

<p class="img-content"><img src="images/book13422.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>В заключение посмотрим результат нашей работы:
</p>

<p class="img-content"><img src="images/book13423.png" alt="Рис. 1.1" width="608" height="296"></p>

<p>Столбцы DEL, INS, UPD, SEL обозначают сокращенные названия опций аудита объектов схемы, а значение S/S является фокусировкой и расшифровывается следующим образом. Буква S перед знаком / и после означает, что протоколирование настроено на удачное или неудачное выполнение команды. Запись при этом будет образовываться только один раз за сеанс при первом выполнении команды (режим SESSION). В результате, мы можем отслеживать доступ только к этим двум таблицам, что позволит сократить количество протоколируемой информации. Правда, данный вид аудита имеет один недостаток. К нему не может применяться фокусировка по конкретному пользователю. Вследствие чего, в данном примере нам придётся отфильтровывать аудитные записи сделанные командами пользователей AH и BE непосредственно при просмотре аудита.
</p>
<h2>Как посмотреть аудит?
</h2>
<p>Включая аудит, мы указали значение инициализационного параметра AUDIT_TRAIL равное DB. Это означает, что в качестве хранилища записей (журнала аудита) у нас выступает таблица AUD$ в схеме SYS. Поэтому, для просмотра аудита мы можем обратиться непосредственно к этой таблице напрямую. Но гораздо удобнее это делать через системные представления журнала аудита. Ознакомимся с ними более подробно. Первое представление, которое мы рассмотрим, называется DBA_AUDIT_TRAIL. Оно единственное напрямую обращается к таблице AUD$ и содержит список всех её записей. Выведем описание этого представления:
</p>
<p class="img-content"><img src="images/book13424.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Предназначение столбцов OS_USERNAME, USERNAME, USERHOST, TERMINAL особо объяснять не надо. Они идентифицируют пользователя, аудит действий которого был выполнен, и компьютер на котором эти действия исполнялись. Столбцы TIMESTAMP и EXTENDED_TIMESTAMP определяют временную метку создания записи в локальном и гринвичском часовом поясе. Поля OWNER, OBJ_NAME указывают объект, на который направлено действие. Код и название этого действия можно узнать из столбцов ACTION и ACTION_NAME. Если была применена команда RENAME, то столбцы NEW_OWNER и NEW_NAME покажут новое название объекта, также здесь содержится имя основного объекта для некоторых типов команд. Группа столбцов OBJ_PRIVILEGE, SYS_PRIVILEGE, ADMIN_OPTION, GRANTEE относиться к выдаче, отбору прав и указывает на сами привилегии, опцию ADMIN и имя пользователя, всё то, что задаётся в командах GRANT или REVOKE. Следующий столбец AUDIT_OPTION показывает параметры аудита, установленные командой AUDIT. В поле SES_ACTIONS отображается суммарная информация по сеансу, в случае установления режима фокусировки SESSION. Группа столбцов LOGOFF_TIME, LOGOFF_LREAD, LOGOFF_PREAD, LOGOFF_LWRITE, LOGOFF_DLOCK относится к информации завершения работы сеанса и обозначает время завершения сеанса, количество логических, физических чтений за сеанс, логических записей и взаимоблокировок, обнаруженных во время работы. В поле COMMENT_TEXT содержится текстовый комментарий к записи аудита. Иногда кстати довольно полезная вещь. Группа столбцов SESSIONID, ENTRYID, STATEMENTID, является, пожалуй, самой главной в представлении. Она содержит информацию о числовых идентификаторах сеанса, записи и выполняемой команды аудита. Именно по информации из двух первых полей можно гарантированно удалить отдельную запись аудита. Следующее поле RETURNCODE – это код ошибки, генерируемый действием. Столбец PRIV_USED при этом показывает системную привилегию, которая использовались для выполнения этого действия. И наконец, последние поля SQL_BIND и SQL_TEXT относятся к расширенному режиму работы аудита и содержат информацию обо всех связанных переменных и тексте SQL оператора, выполняемого действия.
</p>

<p>Следующие представления журнала аудита, которые мы рассмотрим, базируются на представлении DBA_AUDIT_TRAIL, и служат для удобства просмотра записей аудита, так как различаются только информацией выводимой для определённых групп действий. Например, представление DBA_AUDIT_EXISTS служит для вывода записей аудита операций, которые завершились неудачей из-за того, что объект не был найден. Представление DBA_AUDIT_OBJECT показывает аудит всех объектов в базе данных. В DBA_AUDIT_SESSION содержатся записи касающиеся команд CONNECT и DISCONNECT. И наконец, последнее представление DBA_AUDIT_STATEMENT отображает записи аудита команд GRANT, REVOKE, AUDIT, NOAUDIT, ALTER SYSTEM. Делая запрос к этим представлениям, мы можем получить доступ ко всей протоколируемой информации собираемой с помощью аудита. Что даёт нам шанс провести её полный анализ.
</p>
<h2>Проводим анализ
</h2>

<p>И так, мы настроили аудит. Информация о действиях пользователей в базе данных начала собираться. Мы знаем, где ёё можно посмотреть. Но всё это будет напрасно, если мы не сможем разобраться в этом большом количестве разнообразных данных. Поэтому попытаемся выработать основные этапы анализа аудита. Начнём с подключений пользователей к базе данных. Так как в больших системах количество соединений может составлять тысячи за день, нас в первую очередь будут интересовать подключения пользователей обладающих расширенными привилегиями. К таким пользователям относятся системные учётные записи, отдельная учётная запись администратора базы данных, если таковая имеется. Так же к ним можно отнести и пользователей, которые могут изменить критически важные данные, например известные нам пользователи AH и BE. Такие подключения следует, прежде всего, отслеживать по месту откуда делается попытка соединения. Если соединение осуществлялось с компьютера имя, которого отличается от привычного имени, то, скорее всего, произошёл взлом или утечка регистрационных данных учётной записи. Во всяком случае, на эти записи следует обратить внимание. Выполним, к примеру, следующий запрос:
</p>
<p class="img-content"><img src="images/book13425.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>В результате мы видим, что было произведено успешное подключение под учётной системной записью BE с компьютера W005, хотя пользователь раньше всегда соединялся только с терминалов W003 или W004. Возможно, это говорит о том, что учётная запись BE была взломана. Если же проверка успешных подключений привилегированных пользователей не показала ничего подозрительного, то нам стоит проанализировать соединения, которые по тем или иным причинам завершились с ошибкой. Делается это с помощью следующего запроса:
</p>

<p class="img-content"><img src="images/book13426.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>В данном случае видно, что попытка подключения под пользователями AH и BE окончилась неудачей. Но если одиночное неудачное соединение пользователя AH можно списать на ошибку ввода пароля. То аудит подключений пользователя BE может говорить о попытке взлома учётной записи. Кроме вопросов касающихся безопасности аудит подключений можно использовать и в целях определения сеансов сильно загружающих экземпляра базы данных. Всё дело в том, что при удачном завершении подключения в аудит происходит запись некоторой статистики сеанса. Поэтому обращаясь к столбцам SESSION_CPU, LOGOFF_LREAD, LOGOFF_PREAD, LOGOFF_DLOCK можно находить сеансы которые используют, слишком большое количество процессорного времени, осуществляют много физических и логических чтений или имеют взаимоблокировки. Выполним, к примеру, следующий запрос:
</p>

<p class="img-content"><img src="images/book13427.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Здесь мы видим, что сеанс пользователя VP длился девять часов, причём время, в течение которого использовался процессор, составило более восьми часов. Это, скорее всего, говорит о ненормальной работе приложения, в котором работал пользователь. Определить, какое это приложение можно только по числовому идентификатору сеанса SESSIONID. Ему соответствует поле AUDSID представления V$SESSION. К сожалению когда мы будем просматривать аудит мы уже не найдем в этом представлении информацию о сеансе. Поэтому нам придётся дополнительно вести историю сеансов с помощью системных триггеров. Разобравшись с подключениями и не выявив попыток взлома или несанкционированного использования учётных записей, можно попытаться разобраться в остальных действиях пользователей. И начать это лучше с проверки выполнения системных команд. К ним в первую очередь стоит отнести команду ALTER SYSTEM динамически меняющую экземпляр базы данных, команды выдачи, отбора привилегий GRANT и REVOKE, операторы изменения настройки аудита AUDIT и NOAUDIT. Выбрать все записи, образующиеся при выполнении этих команд можно с помощью следующего запроса:
</p>
<p class="img-content"><img src="images/book13428.png" alt="Рис. 1.1" width="608" height="296"></p>

<p>Попробуем провести анализ полученного результата. Первая запись говорит нам о том, что администратором была включена опция аудита PROCEDURE. На это указывает действие SYSTEM AUDIT в столбце ACTION_NAME и название опции в столбце AUDIT_OPTION. Далее следует семь записей, отображающие выдачу администратором объектных привилегий роли HR_PROG, о чём свидетельствует тип действия SYSTEM AUDIT. Столбцы OWNER и OBJ_NAME при этом идентифицируют объект, на который выдаются права, а столбец GRANTEE получателя этих привилегий. Расшифровку выдаваемых прав, можно осуществить с помощью значения столбца OBJ_PRIVILEGE. Здесь каждое положение символа соответствует определённой объектной привилегии. Если символ имеет значение Y, то значит, привилегия на объект была предоставлена. В нашем случае роли были предоставлены все объектные привилегии, которые имеются для данного типа объекта. В следующей записи аудита присутствует действие SYSTEM GRANT, означающее, что администратором была произведена выдача системной привилегии роли HR_PROG. Посмотреть какая привилегия при этом выдавалась можно в столбце SYS_PRIVILEGE. В нашем случае там находится значение ALTER SESSION. Далее мы видим группу записей с общим действием GRANT ROLE. Это действие относится к предоставлению роли пользователям или другим ролям, выдаваемая роль при этом отображается в столбце OBJ_NAME. В нашем случае была произведена выдача администратором роли CONNECT пользователям AH, BE, VP и роли HR_PROG пользователю AH. Причём в последнем случае роль была предоставлена пользователю с правом передачи, о чём свидетельствует присутствие символа A в столбце ADMIN_OPTION. Четырнадцатая запись аудита, пожалуй, не нуждается в пояснении. Действие ALTER SYSTEM явно указывает на то, что администратором была выполнена в системе одноименная команда и дополнительной информации мы здесь не увидим. Последние две записи аудита относятся, как было ранее рассмотрено, к предоставлению ролей пользователям. Но выдачу этих ролей осуществляют не привилегированные пользователи. Так мы видим, что пользователь AH предоставил роль HR_PROG пользователю BE, без права передачи, который в свою очередь попытался выдать эту роль пользователю VP, но потерпел неудачу. Ошибка при этом отобразилась в столбце RETURNCODE. Анализ аудита, осуществляемый с использованием представления DBA_AUDIT_STATEMENT, имеет большое значение, так как именно на этом этапе есть возможность определить попытки повышения привилегий учётной записи и вероятность замести следы несанкционированных действий путём изменения настроек аудита. Поэтому надо внимательно анализировать все без исключения записи на предмет, кто выполняет, какие действия, в какое время и главное откуда. Если же нам на этом этапе не удалось обнаружить никаких подозрительных действий, то мы можем спокойно переходить к следующему виду анализа аудита – анализу действий над объектами. Под объектами здесь подразумевается не только объекты схемы, но и системные объекты: пользователи, профили, роли, табличные пространства и т.д. Посмотреть аудит этих объектов можно с помощью следующего запроса:
</p>

<p class="img-content"><img src="images/book13429.png" alt="Рис. 1.1" width="608" height="296"></p>

<p>Проанализируем полученный результат. В первых четырёх записях мы видим, что администратор создал роль HR_PROG и учетные записи пользователей AH, BE, VP. Их имена отображены в столбце OBJ_NAME, а действия совпадают с названиями применяемых SQL команд. После этого администратор включил триггер безопасности HR.SECURE_EMPLOYEES. На это указывает действие ENABLE TRIGGER и имя объекта в полях OWNER и OBJ_NAME. Далее пользователь AH попытался обратиться к таблице HR.EMPLOYEES. Но вместо какого либо понятного нам действия, в столбце ACTION_NAME мы видим лишь значение SESSION REC. На самом деле это значение означает, что запись факта всех действий для этого объекта в течение сеанса будет отображаться в этой записи, так как настройке опций был применён режим по умолчанию BY SESSION. Определить какие команды применялись к данному объекту можно по положению специального символа в столбце SES_ACTIONS. В нашем случае это положение соответствует команде UPDATE, а сам символ имеет значение F, что означает неудачное выполнение команды. После этого пользователь AH попытался выключить триггер безопасности HR.EMPLOYEES. Но потерпел неудачу. Это видно по значению поля RETURNCODE. Далее этим же пользователем были выполнены две команды SELECT и UPDATE применительно к объекту HR.JOBS. Это было определено из положения символов S в значении столбца SES_ACTIONS. Кстати данный символ свидетельствует об успешном выполнении команды. Продолжая анализ, мы видим, что в следующей записи присутствует действие CREATE TRIGGER, которое говорит нам о том, что администратор изменил триггер HR.SECURE_EMPLOYEES. Поле NEW_NAME здесь указывает на основной объект. В нашем случае это таблица HR.EMPLOYEES, к которой относится данный триггер. После того как триггер пересоздан, пользователь AH получил возможность удачно выполнить команду UPDATE для таблицы HR.EMPLOYEES, на это указывает положение символа S в значении столбца SES_ACTIONS. И наконец, в последней записи аудита видно как пользователь BE осуществил доступ к таблице HR.JOBS. Но в значении столбца SES_ACTIONS мы видим только символ B. Позиция его соответствует выполненной команде SELECT, но результат выполнения команды неизвестен. На самом деле присутствие этого символа означает, что произошло удачное и одновременно неудачное выполнение команды в течение сеанса.
</p>
<h2>Используем расширенный режим
</h2>

<p>Проводя анализ аудита мы видели, что в журнале сохраняется довольно много информации, достаточной для того чтобы идентифицировать то действие которое выполнил пользователь. Но если мы захотим более подробно разобраться в том какая, же команда была выполнена, то здесь нас ждёт неудача. Поясним это на примере:
</p>

<p class="img-content"><img src="images/book13430.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Рассматривая результат запроса, мы видим, что администратор выполнил какое-то изменение экземпляра базы данных с помощью команды ALTER SYSTEM. Но нам не видно, какие конкретно изменения он сделал. Это могло быть и изменение инициализационного параметра, и уничтожение сеанса пользователя. Если бы мы знали, какую команду выполнил пользователь в данный момент времени, мы могли бы точнее определить само действие и опасность его для системы. К счастью в Oracle начиная с девятой версии, предусмотрен расширенный режим аудита. В данном режиме в качестве дополнения в журнал аудита записываются исполняемые SQL команды, или значения переменных привязки, если таковые имеются. Включается данный режим изменением параметра инициализации AUDIT_TRAIL. Для этого надо присвоить ему значение DB,EXTENDED. Попробуем включить данный режим:
</p>

<p class="img-content"><img src="images/book13431.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Перезагрузим экземпляр и проверим правильность установки значения параметра:
</p>
<p class="img-content"><img src="images/book13432.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>Расширенный режим установился. Заполним журнала аудита новой информацией. И если теперь мы повторим запрос к представлению журнала, то увидим, что в столбце SQL_TEXT появился текст выполненной команды:
</p>

<p class="img-content"><img src="images/book13433.png" alt="Рис. 1.1" width="608" height="296"></p>
<p>В результате становиться понятно, какие действия совершил пользователь SYSTEM с экземпляром базы данных. Правда иногда, когда в SQL операторе используются связанные переменные, текст команды не даёт полной информации о совершаемом действии. В этом случае нам надо знать значения этих переменных. К примеру, в результате выполнения следующего запроса мы видим две записи с совершенно одинаковыми DML командами. Единственное что их отличает это значения связанных переменных, отображённых в столбце SQL_BIND.
</p>

<p class="img-content"><img src="images/book13434.png" alt="Рис. 1.1" width="608" height="296"></p>

<p>В заключение хочется сказать, что расширенный режим аудита является очень затратным в плане ресурсов. Поэтому включать его без острой необходимости не рекомендуется.
</p>

     </div>
     <nav role="navigation" aria-labelledby="book-label-2" class="book-navigation">
       <div class="page-links"><a href="book133.html" rel="prev" class="page-previous" title="Прошлая Тема">
         <i class="arrow icon-prev"><img src="images/arrowleft.png" alt=""></i>Тема 3.3</a>
         <a href="index.html" class="page-up" title="Содержание"><i class="arrow icon-up">
         <img src="images/arrowup.png" alt=""></i>Содержание</a>
         <a href="book135.html" rel="next" class="page-next" title="Следующая тема">Тема 3.5.
           <i class="arrow icon-next"><img src="images/arrowright.png" alt=""></i>
         </a>
       </div>
     </nav>
   </article>
 </div>
</div>
  </div>
</div>
<footer>
  <div class="footer">

  <div class="footer-inner">
    <div class="footer-ss">
     <div class="footer-name">
        <a href="https://nggtk.ru"> <p class="footer-name"><i class="arrow icon-up">
        <img src="images/icon1.png" alt=""></i>Сайт ГАПОУ НГТК</p> </a>
    <a href="https://vk.com/gapou_ngtk"> <p class="footer-name"><i class="arrow icon-up">
    <img src="images/icon2.png" alt=""></i>Группа ГАПОУ НГТК в ВК</p> </a>
     </div>

    </div>
    <div>
      <p>Создано Максяшкиным Валерием Валерьевичем <br>
      С помощью текстового редактора Atom</p>
    </div>
      <a href="#top"class="top">Back to top</a>
  </div>
</div>
</footer>

</body>

</html>
